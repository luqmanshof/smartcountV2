{% extends 'smartapp/base.html' %}
{% load crispy_forms_tags %}
{% load humanize %}


{% block content %}
<section class="content-header">

    <div class="col-xs-12 col-md-2">
        <label>
            EXPENSE MODULE
            <small>...</small>
        </label>
    </div>

    <div class="col-xs-12 col-md-10 pull-right">
        <div class="pull-right form-group col-xs-4 col-md-3 button-small">
            <a href="{% url 'expense_list' %}"><button class="btn btn-danger form-control"
                    type="submit">EXIT</button></a>
        </div>
        
        <div class="pull-right form-group col-xs-4 col-md-3 button-small">
            <button class="btn btn-primary form-control" onClick="" data-toggle="modal"
                data-target="#journalModal">JOURNAL</button>
        </div>
        
        <div class="pull-right form-group col-xs-4 col-md-3">
            <button class="btn btn-success form-control" onClick="saveMain()">SAVE</button>

        </div>

    </div>

</section>


<section>

    <div class="box box-primary col-xs-12 col-md-12">
        <div class="box-body" style="padding-top:15px">
            <div class="col-xs-12">
                <form id="receiptMainForm">
                    {% if expensemain %}
                    <div class="row">
                        <div class="col-xs-6 col-md-2 form-group">
                            <label for="">Voucher Date</label>
                            <input class="form-control" value="{{trans_date}}" type="date" onload="" name="trans_date"
                                id="date" required>
                            <input class="form-control" id="main-id" type="hidden" name="mainId"
                                value="{{expensemain.id}}" />
                        </div>

                        <div class="col-xs-6 col-md-2 form-group">
                            <label for="">Ref Number</label>
                            <input class="form-control" type="text" id="voucher_no" name="voucher_number"
                                value="{{expensemain.voucher_number}}" required disabled>
                        </div>
                        <div class="col-xs-6 col-md-2 form-group">
                            <label for="">Voucher Number</label>
                            <input class="form-control" type="text" id="voucher_no2" name="voucher_number2"
                                value="{{expensemain.voucher_number2}}" required>
                        </div>

                        <div class="col-xs-12 col-md-2 form-group">
                            <label for="">Payee</label>
                            <select name="client_name" id="client" class="form-control">
                                {% for item in staff_name %}
                                <option value="{{ item.id }}"
                                    {% if expensemain.payee_id == item.id %}selected{% endif %}>
                                    {{ item.first_name|add:" "|add:item.last_name }}
                                </option>
                                {% endfor %}
                            </select>

                        </div>
                        <div class="col-xs-12 col-md-4 form-group">
                            <label for="">Narrative:</label>
                            <input class="form-control" type="text" name="bill_to" id="bill_to" placeholder=""
                                value="{{expensemain.description}}" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12 col-md-4 form-group">
                            <label for="">Credit Account</label>
                            <select name="debit_account" id="debit_account" class="form-control">
                                {% for item in note_acct_cash %}
                                <option value="{{ item.id }}"
                                    {% if expensemain.credit_account_id == item.id %}selected{% endif %}>
                                    {{ item.item_name }} |
                                    {{item.sub_category__sub_category_name}} |
                                    {{item.sub_category__category_code__category_name}}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-xs-12 col-md-4 form-group">
                            <label for="">Credit Category</label>
                            <select name="cash_account" id="cash" class="form-control">
                                {% for item in cash_acct %}
                                <option value="{{ item.id }}"
                                    {% if expensemain.cash_account_id == item.id %}selected{% endif %}>
                                    {{ item.sub_category_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-xs-12 col-md-4 form-group">
                            <div class="col-xs-6 col-md-6 form-group">
                                <label for="">Payment Mode</label>
                                <select name="pay_mode" id="pMode" class="form-control">
                                    <option value="Cash" {% if expensemain.pay_mode == 'Cash' %}selected{% endif %}>Cash
                                    </option>
                                    <option value="Cash" {% if expensemain.pay_mode == 'Cheque' %}selected{% endif %}>
                                        Cheque</option>
                                    <option value="Cash" {% if expensemain.pay_mode == 'Transfer' %}selected{% endif %}>
                                        Transfer</option>
                                </select>
                            </div>
                            <div class="col-xs-6 col-md-6 form-group">
                                <label for="">Total Amount:</label>
                                <input class="form-control" type="text" name="total_amount" id="total_amt"
                                    placeholder="0.00" value="{{total_sum|floatformat:2|intcomma}}" required disabled>
                            </div>

                        </div>
                    </div>

                    {% else %}
                    <div class="row">
                        <div class="col-xs-6 col-md-2 form-group">
                            <label for="">Voucher Date</label>
                            <input class="form-control" type="date" onload="" name="trans_date" id="date" required>
                            <input class="form-control" id="main-id" type="hidden" name="mainId" />
                        </div>

                        <div class="col-xs-6 col-md-2 form-group">
                            <label for="">Ref Number</label>
                            <input class="form-control" type="text" id="voucher_no" name="voucher_number"
                                value="{{max_expense.max_val|add:1}}" required disabled>
                        </div>
                        <div class="col-xs-6 col-md-2 form-group">
                            <label for="">Voucher Number</label>
                            <input class="form-control" type="text" id="voucher_no2" name="voucher_number2">
                        </div>
                        <div class="col-xs-12 col-md-2 form-group">
                            <label for="">Payee</label>
                            <select name="client_name" id="client" class="form-control">
                                {% for item in staff_name %}
                                <option value="{{ item.id }}">{{ item.first_name|add:" "|add:item.last_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-xs-12 col-md-4 form-group">
                            <label for="">Narrative:</label>
                            <input class="form-control" type="text" name="bill_to" id="bill_to" placeholder="" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12 col-md-4 form-group">
                            <label for="">Credit Account</label>
                            <select name="debit_account" id="debit_account" class="form-control">
                                <option></option>
                                {% for item in note_acct_cash %}
                                <option value="{{ item.id }}">{{ item.item_name }} |
                                    {{item.sub_category__sub_category_name}} |
                                    {{item.sub_category__category_code__category_name}}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-xs-12 col-md-4 form-group">
                            <label for="">Credit Category</label>
                            <select name="cash_account" id="cash" class="form-control">
                                <option></option>
                                {% for item in cash_acct %}
                                <option value="{{ item.id }}">{{ item.sub_category_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-xs-12 col-md-4 form-group">
                            <div class="col-xs-6 col-md-6 form-group">
                                <label for="">Payment Mode</label>
                                <select name="pay_mode" id="pMode" class="form-control">
                                    <option value="Cash">Cash</option>
                                    <option value="Cash">Cheque</option>
                                    <option value="Cash">Transfer</option>
                                </select>
                            </div>
                            <div class="col-xs-6 col-md-6 form-group">
                                <label for="">Total Amount:</label>
                                <input class="form-control" type="text" name="total_amount" id="total_amt"
                                    placeholder="0.00" required disabled>
                            </div>

                        </div>
                    </div>

                    {% endif %}

                    <!-- <button type="submit">Save</button> -->
                </form>

            </div>
        </div>

    </div>



    <div class="box box-primary col-xs-12">

        <div class="box-body">
            <div class="col-md-3">
                <h4>Enter Details</h4>
                <!-- /.box -->
                <div class="box">
                    <div class="box-body">
                        <!-- <h3>ADD USER</h3> -->
                        <form id="receiptSub" action="">
                            <div class="form-group">
                                <input class="form-control" type="text" name="description" placeholder="description"
                                    required>
                            </div>
                            <div class="form-group">
                                <input class="form-control" type="text" name="amount" id="amount" placeholder="0.00"
                                    required>
                            </div>

                            <div class="form-group">
                                <label for="">Expense Department</label>
                                <select name="budget_dept" id="budget_dept" class="form-control" required>
                                    <option></option>
                                    {% for item in department %}
                                    <option value="{{ item.id }}">{{ item.budget_dept }} - {{ item.budget_item }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="">Expense Account</label>
                                <select name="credit_account" id="credit_account" class="form-control" required
                                    disabled>
                                    <option></option>
                                    {% for item in note_acct_exp %}
                                    <option value="{{ item.id }}">{{ item.item_name }} |
                                        {{item.sub_category__sub_category_name}} |
                                        {{item.sub_category__category_code__category_name}}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group" hidden>
                                <label for="">Expense Category</label>
                                <select name="expense_account" id="expense" class="form-control">
                                    <option></option>
                                    {% for item in expense_acct %}
                                    <option value="{{ item.id }}">{{ item.sub_category_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <!-- <input class="form-control" type="number" name="age" min="10" max="100" placeholder="Age" required> -->
                            </div>

                            <button class="btn btn-primary form-control" type="submit">ADD RECORD</button>
                            <!-- <button class="btn btn-primary form-control" type="submit">SUBMIT</button> -->
                        </form>

                    </div>
                </div>


            </div>

            <div class="col-md-9">
                <h4>...</h4>
                <!-- /.box -->
                <div class="row" id="divList">
                    <div class="col-xs-12">
                        <div class="box">
                            <div class="box-body">
                                <table id="itemTable" class="table table-striped">
                                    <thead>
                                        <tr style="font-size:12px;">
                                            <th>Department</th>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th>Expense Account</th>
                                            <th>Amount</th>
                                            <th hidden>Budget ID</th>
                                            <th style="text-align: center;"> _ </th>
                                            <th style="text-align: center;"> _ </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- table_list -->
                                        {% if expenseitems %}
                                        {% for item in expenseitems %}
                                        <tr style="font-size:12px;" id="item-{{item.id}}">
                                            <td class="itemDepartment itemData" name="department">
                                                {{item.budget_dept__budget_dept__department_name}}</td>
                                            <td class="itemDescription itemData" name="description">{{item.description}}
                                            </td>
                                            <td class="itemExpenseAcct itemData" name="expense">
                                                {{item.expense_account__sub_category_name}}</td>
                                            <td class="itemCreditAcct itemData" name="credit">
                                                {{item.Debit_account__item_name}}
                                            </td>
                                            <td class="itemAmount itemData" style="text-align: right;" name="amount">
                                                {{item.amount|floatformat:2|intcomma}}
                                            </td>
                                            <td class="itemBudgetID itemData" name="budget" hidden>{{item.budget_dept__id}}</td>
                                            <td align="center">
                                                <button class="btn btn-success form-control button-small"
                                                    onClick="editItem({{item.id}})" data-toggle="modal"
                                                    data-target="#myModal">EDIT</button>
                                            </td>
                                            <td align="center">
                                                <button class="btn btn-danger form-control button-small"
                                                    onClick="deleteItem({{item.id}})">DELETE</button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <!-- No Item Listed -->
                                        {% endif %}

                                    </tbody>
                                </table>
                            </div>
                            <!-- /.box-body -->
                        </div>

                    </div>

                </div>

                <label for="">...</label>

                <!-- /.box -->
            </div>
            <!-- /.col -->

        </div>

    </div>

</section>

<!-- Edit Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="myModalLabel">Edit Details</h4>
            </div>
            <!-- /.box -->
            <div class="box">
                <div class="box-body">
                    <form id="updateReceiptSub" action="">
                        <input class="form-control" id="sub_id" type="hidden" name="sub_id" />
                        <div class="form-group col-md-6">
                            <label for="">Description</label>
                            <input class="form-control" type="text" id="description_edit" name="description_edit"
                                placeholder="description" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="">Amount</label>
                            <input class="form-control" type="text" id="amount_edit" name="amount_edit"
                                placeholder="0.00" required>
                        </div>
                        <div class="form-group col-md-12">
                            <label for="">Expense Department</label>
                            <select name="budget_dept_edit" id="budget_dept_edit" class="form-control" required>
                                <option></option>
                                {% for item in department %}
                                <option value="{{ item.id }}">{{ item.budget_dept }} - {{ item.budget_item }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-12">
                            <label for="">Expense Account</label>
                            <select name="credit_account_edit" id="credit_account_edit" class="form-control" required
                                disabled>
                                <option></option>
                                {% for item in note_acct_exp %}
                                <option value="{{ item.id }}">{{ item.item_name }} |
                                    {{item.sub_category__sub_category_name}} |
                                    {{item.sub_category__category_code__category_name}}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" hidden>
                            <label for="">Expense Category</label>
                            <select name="expense_edit" id="expense_edit" class="form-control" required>
                                {% for item in expense_acct %}
                                <option value="{{ item.id }}">{{ item.sub_category_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <!-- <input class="form-control" type="number" name="age" min="10" max="100" placeholder="Age" required> -->
                        </div>
                    </form>
                    <div class="col-sm-6">
                        <button class="btn btn-primary form-control" onclick="saveRecordEdit()" type="submit">UPDATE
                            RECORD</button>
                    </div>
                    <div class="col-sm-6">
                        <button type="button" class="btn btn-danger form-control" data-dismiss="modal">CLOSE</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<!-- END Edit Modal -->

<!-- View Journal Modal -->
<div id="journalview">
    {% include 'account/journal_view.html' %}
</div>
<!-- END Journal Modal -->

{% endblock %}

{% block javascript %}
<script>
    var CategoryCode, CategoryCode2, CategoryId;
    var trans_date, amountInput, debit_acct, credit_acct, clientID, totalAmount, budget_dept;
    $(document).ready(function () {
        $('#itemTable').DataTable({
            "pageLength": 10,
        });

        $("select#cash").change(function () {
            CategoryCode = $(this).children("option:selected").val();
            populate_account_items(CategoryCode, 'debit_account');
        });

        $("select#expense,select#expense_edit").change(function () {
            CategoryCode2 = $(this).children("option:selected").val();
            populate_account_items(CategoryCode2, 'credit_account');
            populate_account_items(CategoryCode2, 'credit_account_edit');
        });

        $("select#debit_account").change(function () {
            debit_acct = $(this).children("option:selected").val();
            console.log(debit_acct)
            get_cat_item(debit_acct, 'cash');
        });

        $("select#credit_account").change(function () {
            credit_acct = $(this).children("option:selected").val();
            console.log('ITEM CHANGED' + credit_acct)
            get_cat_item(credit_acct, 'expense');
        });

        $("select#credit_account_edit").change(function () {
            credit_acct = $(this).children("option:selected").val();
            console.log('ITEM CHANGED' + credit_acct)
            get_cat_item(credit_acct, 'expense_edit');
        });

        //budget_dept
        $("select#budget_dept").change(function () {
            budget_dept = $(this).children("option:selected").val();
            get_budget_exp(budget_dept, 'credit_account');
        });

        $("select#budget_dept_edit").change(function () {
            budget_dept = $(this).children("option:selected").val();
            get_budget_exp(budget_dept, 'credit_account_edit');
        });

        $("select#client").change(function () {
            clientID = $(this).children("option:selected").val();
            console.log(clientID)
        });

        $("#amount, #amount_edit").focusout(function () {
            $(this).val(ReplaceNumberWithCommas($(this).val()));
        });

        $("#amount, #amount_edit").keydown(function (e) {
            if (e.keyCode == 13) {
                $(this).val(ReplaceNumberWithCommas($(this).val()));
            }
        });


        //DATE PICKER
        $.fn.setNow = function (onlyBlank) {
            var now = new Date($.now())
                , year
                , month
                , date
                , hours
                , minutes
                , seconds
                , formattedDateTime
                ;

            year = now.getFullYear();
            month = now.getMonth().toString().length === 1 ? '0' + (now.getMonth() + 1).toString() : now.getMonth() + 1;
            date = now.getDate().toString().length === 1 ? '0' + (now.getDate()).toString() : now.getDate();
            hours = now.getHours().toString().length === 1 ? '0' + now.getHours().toString() : now.getHours();
            minutes = now.getMinutes().toString().length === 1 ? '0' + now.getMinutes().toString() : now.getMinutes();
            seconds = now.getSeconds().toString().length === 1 ? '0' + now.getSeconds().toString() : now.getSeconds();

            // formattedDateTime = year + '-' + month + '-' + date + 'T' + hours + ':' + minutes + ':' + seconds;
            formattedDateTime = year + '/' + month + '/' + date;

            if (onlyBlank === true && $(this).val()) {
                return this;
            }

            $(this).val(formattedDateTime);

            return this;
        }

        if ($('#main-id').val()) {

        } else {
            $(function () {
                // Handler for .ready() called.
                $('input[type="datetime-local"]').setNow();

            });
        }


        //DEFAULTS
        if ($('#main-id').val()) {
            CategoryCode = $('#cash').children("option:selected").val();
            CategoryCode2 = $('#expense').children("option:selected").val();
            debit_acct = $('#debit_account').children("option:selected").val();
            credit_acct = $('#credit_account').children("option:selected").val();
            clientID = $('#client').children("option:selected").val();
            budget_dept = $('#budget_dept').children("option:selected").val();

        }
        else {
            $('#client, #cash, #expense, #debit_acct').val('');
            $('#total_amt').val('0.00');
        }

    });


    function populate_account_items(CatCode, acctId) {
        $.ajax({
            url: '{% url "populate_noteitems" %}',
            data: {
                'sub_category': CatCode
            },
            dataType: 'json',
            success: function (result) {
                console.log(result);
                $("#" + acctId + " option").remove();
                for (var i = result.length - 1; i >= 0; i--) {
                    //$("#" + acctId).append('<option>' + result[i].item + '</option>');
                    $("#" + acctId).append('<option value="' + result[i].itemID + '">' + result[i].item + '</option>');
                };
                $("#" + acctId).val('');
            },
        });

    }

    function get_cat_item(ItemCode, acctId) {
        $.ajax({
            url: '{% url "get_acctcat" %}',
            data: {
                'item_code': ItemCode
            },
            dataType: 'json',
            success: function (data) {
                console.log(data);
                itemID = data.selected_category;
                $("#" + acctId).val(itemID);
                if (acctId == 'cash')
                    CategoryCode = itemID;
                else if (acctId == 'expense')
                    CategoryCode2 = itemID;
            },
        });

    }

    function get_budget_exp(ItemCode, acctId) {
        $.ajax({
            url: '{% url "get_budgetexp" %}',
            data: {
                'item_code': ItemCode
            },
            dataType: 'json',
            success: function (data) {
                console.log(data.values[0].id);
                itemID = data.values[0].id;
                $("#" + acctId).val(itemID);
                credit_acct = $("#" + acctId).children("option:selected").val();
                console.log('CREDIT ACCOUNT : ' + credit_acct);
                if (acctId == 'credit_account') {
                    get_cat_item(credit_acct, 'expense');
                } else {
                    get_cat_item(credit_acct, 'expense_edit');
                }

            },
        });

    }


    viewJournal();

    function viewJournal() {
        ref_no = $('input[name="voucher_number"]').val().trim();
        var journal_url = '/smartsetup/journal_view/(' + ref_no + ')/(CDJ)'

        $.ajax({
            url: journal_url,
            success: function () {
                $("#journalview").load(journal_url);
            },
        });
    }


    // Create Django Ajax Call
    $("#receiptSub").submit(function () {
        //alert("Stage 1...");

        trans_date = $('input[name="trans_date"]').val().trim();
        voucher_no = $('input[name="voucher_number"]').val().trim();
        voucher_no2 = $('input[name="voucher_number2"]').val().trim();
        received_from = $('input[name="bill_to"]').val().trim();
        mainID = $('input[name="mainId"]').val().trim();
        description = $('input[name="description"]').val().trim();
        amountInput = $('input[name="amount"]').val().trim();
        totalAmount = $('input[name="total_amount"]').val().trim();
        budget_dept = $('#budget_dept').children("option:selected").val();
        //alert("Stage 2...");

        console.log(trans_date);
        console.log(voucher_no);
        console.log(amountInput);
        console.log('START');
        console.log(debit_acct);
        console.log(credit_acct);
        console.log('END');
        console.log(received_from);
        console.log(CategoryCode);
        console.log(CategoryCode2);
        if (trans_date && voucher_no && CategoryCode && received_from) {
            // Create Ajax Call
            //alert("Stage 3...");
            $.ajax({
                url: '{% url "expense_ajax_create" %}',
                data: {
                    'trans_date': trans_date,
                    'voucher_number': voucher_no,
                    'voucher_number2': voucher_no2,
                    'client_name': clientID,
                    'bill_to': received_from,
                    'cash_account': CategoryCode,
                    'Debit_account': debit_acct,
                    'mainID': mainID,
                    'description': description,
                    'expense_account': CategoryCode2,
                    'credit_account': credit_acct,
                    'amount': amountInput,
                    'total_amount': totalAmount,
                    'budget_dept': budget_dept,
                },
                dataType: 'json',
                success: function (data) {
                    if (data.expense_main) {
                        alert('Success!!!')
                        //clearList();
                        console.log(data.expense_sub)
                        console.log(data.expense_main.Mainid)
                        $('#main-id').val(data.expense_main.Mainid);
                        $('#total_amt').val(data.total_sum);
                        rec = data.expense_sub
                        $("#itemTable > tbody:last-child").append(`
                <tr id="item-${rec.Subid}">
                    <td class="itemDepartment" name="department">${rec.budget_dept}</td>
                    '<td class="itemDescription" name="description">${rec.description}</td>
                    '<td class="itemExpenseAcct" name="expense">${rec.expense_account}</td>
                    '<td class="itemCreditAcct" name="credit">${rec.debit_account}</td>
                    '<td class="itemAmount" name="amount">${ReplaceNumberWithCommas(rec.amount)}</td>
                    '<td class="itemBudgetID" name="budget" hidden>${rec.budget_id}</td>
                    '<td align="center">
                        <button class="btn btn-success form-control" onClick="editItem(${rec.Subid})" data-toggle="modal" data-target="#myModal")">EDIT</button>
                    </td>
                    <td align="center">
                        <button class="btn btn-danger form-control" onClick="deleteItem(${rec.Subid})">DELETE</button>
                    </td>
                </tr>
              `);

                    }

                    if (data.journal_list) {
                        console.log(data.journal_list)
                        //populateJournalList(data.journal_list);
                        viewJournal();
                    }
                }
            });
        } else {
            alert("All fields must have a valid value.");
        }
        //$('form#receiptSub').trigger("reset");
        return false;
    });



    function saveRecordEdit() {
        // alert('EDIT RECORD ?');
        trans_date = $('input[name="trans_date"]').val().trim();
        voucher_no = $('input[name="voucher_number"]').val().trim();
        voucher_no2 = $('input[name="voucher_number2"]').val().trim();
        received_from = $('input[name="bill_to"]').val().trim();
        mainID = $('input[name="mainId"]').val().trim();
        description = $('input[name="description_edit"]').val().trim();
        amountInput = $('input[name="amount_edit"]').val().trim();
        totalAmount = $('input[name="total_amount"]').val().trim();
        budget_dept = $('#budget_dept_edit').children("option:selected").val();
        CategoryCode2 = $('#expense_edit').children("option:selected").val();
        credit_acct = $('#credit_account_edit').children("option:selected").val();

        subID = $('input[name="sub_id"]').val().trim();
        //alert("Stage 2...");

        console.log(trans_date);
        console.log(voucher_no);
        console.log(amountInput);
        console.log('START');
        console.log(debit_acct);
        console.log(credit_acct);
        console.log('END');
        console.log(received_from);
        console.log(CategoryCode);
        console.log(CategoryCode2);
        //alert("Stage 3...");

        if (!(amountInput)) {
            alert("You must enter an Amount or Value.");
        }
        else {

            if (trans_date && voucher_no && CategoryCode && received_from) {
                // Create Ajax Call
                //alert("Stage 3...");
                $.ajax({
                    url: '{% url "expense_ajax_create" %}',
                    data: {
                        'trans_date': trans_date,
                        'voucher_number': voucher_no,
                        'voucher_number2': voucher_no2,
                        'client_name': clientID,
                        'bill_to': received_from,
                        'cash_account': CategoryCode,
                        'Debit_account': debit_acct,
                        'mainID': mainID,
                        'description': description,
                        'expense_account': CategoryCode2,
                        'credit_account': credit_acct,
                        'amount': amountInput,
                        'total_amount': totalAmount,
                        'budget_dept': budget_dept,
                        'subID': subID,
                    },
                    dataType: 'json',
                    success: function (data) {
                        if (data.expense_main) {
                            alert('Record Edited Successfully')
                            $("#itemTable #item-" + subID).remove();

                            //clearList();
                            console.log(data.expense_sub)
                            console.log(data.expense_main.Mainid)
                            $('#main-id').val(data.expense_main.Mainid);
                            $('#total_amt').val(data.total_sum);
                            rec = data.expense_sub
                            $("#itemTable > tbody:last-child").append(`
                    <tr id="item-${rec.Subid}">
                        <td class="itemDepartment" name="department">${rec.budget_dept}</td>
                        '<td class="itemDescription" name="description">${rec.description}</td>
                        '<td class="itemExpenseAcct" name="expense">${rec.expense_account}</td>
                        '<td class="itemCreditAcct" name="credit">${rec.debit_account}</td>
                        '<td class="itemAmount" name="amount">${ReplaceNumberWithCommas(rec.amount)}</td>
                        '<td class="itemBudgetID" name="budget" hidden>${rec.budget_id}</td>
                        '<td align="center">
                            <button class="btn btn-success form-control" onClick="editItem(${rec.Subid})" data-toggle="modal" data-target="#myModal")">EDIT</button>
                        </td>
                        <td align="center">
                            <button class="btn btn-danger form-control" onClick="deleteItem(${rec.Subid})">DELETE</button>
                        </td>
                    </tr>
                  `);

                        }

                        if (data.journal_list) {
                            console.log(data.journal_list)
                            //populateJournalList(data.journal_list);
                            viewJournal();
                        }
                    }
                });

                //clearList();
                //clearEditModal();

            } else {
                alert("All fields must have a valid value.");
            }
            $('form#updateReceiptSub').trigger("reset");
            $('#myModal').modal('hide');
            return false;
        }
        return false;

    }


    function saveMain() {
        trans_date = $('input[name="trans_date"]').val().trim();
        voucher_no = $('input[name="voucher_number"]').val().trim();
        voucher_no2 = $('input[name="voucher_number2"]').val().trim();
        received_from = $('input[name="bill_to"]').val().trim();
        mainID = $('input[name="mainId"]').val().trim();

        if (received_from) {
            console.log("I GOT HERE");
            $.ajax({
                url: '{% url "expense_savemain" %}',
                data: {
                        'trans_date': trans_date,
                        'voucher_number': voucher_no,
                        'voucher_number2': voucher_no2,
                        'client_name': clientID,
                        'bill_to': received_from,
                        'cash_account': CategoryCode,
                        'Debit_account': debit_acct,
                        'mainID': mainID,
                },
                dataType: 'json',
                success: function () {
                    alert("Record Saved Successfully")
                    // $("#journalview").load(journal_url);
                },
            });
        } else {
            alert("RECORD NOT SAVED. Please enter the Narrative")
        }

    }

    $('#client').change(function () {
        $('#bill_to').val($(this).find('option:selected').text());
    });

    $(function () {
        $(".select-placeholder").prepend("<option value='' disabled selected>Select an option...</option>");
        // This will make every element with the class "date-picker" into a DatePicker element
        $('.date-picker').datepicker();
    })

    function clearList() {
        console.log('CLEAR LIST');
        $('#itemTable tr').each(function () {
            //console.log(this.id)
            var str = this.id;
            var res = str.split("-").pop()
            //var res = this.id.slice(5, 6);
            console.log(res);
            $("#itemTable #item-" + res).remove();

        })
    }

    function clearJournalList() {
        console.log('CLEAR JOURNAL LIST');
        $('#journalTable tr').each(function () {
            //console.log(this.id)
            var str = this.id;
            var res = str.split("-").pop()
            //var res = this.id.slice(5, 6);
            console.log(res);
            $("#journalTable #item-" + res).remove();

        })
    }

    function deleteItem(id) {
        var action = confirm("Are you sure you want to delete this item?");
        mainID = $('input[name="mainId"]').val().trim();
        voucher_no = $('input[name="voucher_number"]').val().trim();

        if (action != false) {
            $.ajax({
                url: '{% url "expense_ajax_delete" %}',
                data: {
                    'id': id,
                    'mainID': mainID,
                    'voucher_number': voucher_no
                },
                dataType: 'json',
                success: function (data) {
                    if (data.deleted) {
                        alert('Item deleted Successfully')
                        console.log(id);
                        $("#itemTable #item-" + id).remove();
                        $('#total_amt').val(data.total_sum);
                        //$("#itemTable).remove();
                    }
                    if (data.journal_list) {
                        //populateJournalList(data.journal_list);
                        viewJournal();
                    }
                }
            });
        }
    }

    function editItem(id) {
        if (id) {
            tr_id = "#item-" + id;
            description = $(tr_id).find(".itemDescription").text().trim();
            ExpenseAcct = $(tr_id).find(".itemExpenseAcct").text().trim();
            creditAcct = $(tr_id).find(".itemCreditAcct").text().trim();
            amount = $(tr_id).find(".itemAmount").text().trim();

            budgetDepart = $(tr_id).find(".itemBudgetID").text().trim();
            //alert(budgetDepart);

            $.ajax({
                url: '{% url "ajax_getacctID" %}',
                data: {
                    'creditAcct': creditAcct
                },
                dataType: 'json',
                success: function (data) {
                    //alert('SUCCESS!!!');

                    $('#sub_id').val(id);
                    $('#description_edit').val(description);
                    $('#expense_edit').val(data.cat_id);
                    $('#credit_account_edit').val(data.note_id);
                    $('#amount_edit').val(amount);
                    $('#budget_dept_edit').val(budgetDepart);

                }
            });

        }
    }

</script>

{% endblock %}